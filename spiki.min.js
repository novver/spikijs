const spiki=(()=>{const a=Object.create(null),[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Set;let f,g,h=Promise.resolve();const i=(a,b)=>{if(!b.includes("."))return a[b];const c=b.split(".");for(let d=0;d<c.length;d++)if(a=a?.[c[d]],void 0===a)return;return a},j=a=>!e.has(a)&&e.add(a)&&!g&&(g=!0)&&h.then(()=>(e.forEach(a=>a()),e.clear(),g=!1)),l=(a,b)=>{if(!f)return;let d=c.get(a);d||c.set(a,d=new Map);let e=d.get(b);e||d.set(b,e=new Set),e.add(f),f.d.add(e)},m=(a,b)=>{const d=c.get(a)?.get(b);d&&[...d].forEach(a=>a.x?a.x(a):a())},n=a=>(a.d.forEach(b=>b.delete(a)),a.d.clear()),o=(a,b)=>{const c=()=>{n(c);const b=f;f=c;try{a()}finally{f=b}};return c.d=new Set,c.x=b,c(),()=>n(c)},p=a=>{if(!a||"object"!=typeof a||a._p||a instanceof Node)return a;if(d.has(a))return d.get(a);const b=new Proxy(a,{get(a,b,c){if("_p"===b)return!0;l(a,b);const d=Reflect.get(a,b,c);return"object"==typeof d&&d&&!(d instanceof Node)?p(d):d},set(a,b,c,d){const e=a[b],f=Reflect.set(a,b,c,d);return e!==c&&(m(a,b),Array.isArray(a)&&"length"!==b&&m(a,"length")),f}});return d.set(a,b),b},q={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>{"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value=b??""},class:(a,b)=>a.className=(a._oc??=a.className)+(b?" "+b:""),attr:(a,b,c)=>{!1===b||null===b||b===void 0?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b)}},r=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=p(d());f.$refs={};const g=[],h=a=>{for(let d=a.target;d&&d!==c.parentNode;){const c=b.get(d)?.[a.type];if(c){const b=d._s||f,e=i(b,c);"function"==typeof e&&e.call(b,a)}d=d.parentNode}},l=(a,b)=>b.push(o(a,j)),m=(a,d,e)=>{if(1!==a.nodeType||a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data"))return;let g;if(g=a.getAttribute("s-if")){const b=document.createTextNode("");a.replaceWith(b);let c,f=[];return void l(()=>{if(i(d,g))c||(c=a.cloneNode(!0),c.removeAttribute("s-if"),m(c,d,f),b.parentNode.insertBefore(c,b));else if(c){for(;f.length;)f.pop()();c.remove(),c=null}},e)}if("TEMPLATE"===a.tagName&&(g=a.getAttribute("s-for"))){const b=g.match(/^\s*(\w+)\s+in\s+(\S+)\s*$/);if(!b)return;const[,c,f]=b,h=document.createTextNode("");a.replaceWith(h);let j=new Map;return void l(()=>{const b=i(d,f)||[],e=new Map;let g=h;if(Array.isArray(b))for(let f=0;f<b.length;f++){const h=b[f],i="object"==typeof h&&null!==h?h:f+"_"+h;let k=j.get(i);if(!k){const b=a.content.cloneNode(!0),e=Object.create(d);e[c]=h,e.$index=f,e.$parent=d;const g=Array.from(b.childNodes),i=[];for(let a=0;a<g.length;a++)m(g[a],e,i);k={n:g,s:e,k:i}}else k.s.$index=f,k.s[c]=h;if(k.n[0]!==g.nextSibling){const a=document.createDocumentFragment();k.n.forEach(b=>a.appendChild(b)),g.parentNode.insertBefore(a,g.nextSibling)}g=k.n[k.n.length-1],e.set(i,k),j.delete(i)}j.forEach(a=>{a.k.forEach(a=>a()),a.n.forEach(a=>a.remove())}),j=e},e)}const j=a.attributes;for(let g=j.length-1;0<=g;g--){const{name:k,value:m}=j[g];if(k.startsWith("@")){const e=k.slice(1);a._s=d;let f=b.get(a);f||b.set(a,f={}),f[e]=m,c._e||(c._e=new Set),c._e.has(e)||(c.addEventListener(e,h),c._e.add(e))}else if(k.startsWith(":")){const b=k.slice(1),c="class"===b?q.class:q.attr;l(()=>c(a,i(d,m),b),e)}else if(k.startsWith("s-")){const b=k.slice(2);"ref"===b?f.$refs[m]=a:q[b]&&l(()=>q[b](a,i(d,m)),e)}}for(let b=a.firstElementChild;b;){const a=b.nextElementSibling;m(b,d,e),b=a}};return m(c,f,g),f.init&&f.init(),{unmount:()=>{g.forEach(a=>a()),c._m=0}}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(r)}})();export default spiki;
