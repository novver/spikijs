const spiki=(()=>{const a=Object.create(null),[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Map,f=new Set;let g,h,i,j=!0,k=Promise.resolve();const l={};["push","pop","shift","unshift","splice","sort","reverse"].forEach(a=>l[a]=function(...b){j=!1;const c=Array.prototype[a].apply(this,b);return j=!0,q(this,"length"),c});const m=a=>{const b=Object.create(a);return new Proxy(b,{set:(a,b,c,d)=>{if(a.hasOwnProperty(b))return Reflect.set(a,b,c,d);let e=a;for(;e&&!Object.prototype.hasOwnProperty.call(e,b);)e=Object.getPrototypeOf(e);return Reflect.set(e||a,b,c)}})},n=(a,b)=>{if("string"!=typeof b)return{val:b,ctx:a};let c=e.get(b);c||e.set(b,c=b.split("."));let d=a,f=a;for(const e of c){if(null==d)break;f=d,d=d[e]}return{val:d,ctx:f}},o=a=>!f.has(a)&&f.add(a)&&!h&&(h=!0)&&k.then(()=>(f.forEach(a=>a()),f.clear(),h=!1)),p=(a,b)=>{if(!g)return;let d=c.get(a)??c.set(a,new Map).get(a),e=d.get(b)??d.set(b,new Set).get(b);e.add(g),g.d.add(e)},q=(a,b)=>j&&c.get(a)?.get(b)?.forEach(a=>a.x?a.x(a):a()),r=(a,b)=>{const c=()=>{c.d.forEach(a=>a.delete(c)),c.d.clear();const b=g;g=c;try{a()}finally{g=b}};return c.d=new Set,c.x=b,c(),()=>(c.d.forEach(a=>a.delete(c)),c.d.clear(),f.delete(c))},s=a=>!a||"object"!=typeof a||a._p||a instanceof Node?a:d.get(a)||d.set(a,new Proxy(a,{get:(a,b,c)=>{if("_p"===b)return!0;if(Array.isArray(a)&&l.hasOwnProperty(b))return l[b];p(a,b);const d=Reflect.get(a,b,c);return d&&"object"==typeof d&&!(d instanceof Node)?s(d):d},set:(a,b,c,d)=>{const e=a[b],f=Array.isArray(a)?+b<a.length:Object.prototype.hasOwnProperty.call(a,b),g=Reflect.set(a,b,c,d);if(j&&(f?e!==c&&q(a,b):(q(a,b),Array.isArray(a)&&q(a,"length"))));return g}})).get(a);i=s({});const t={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value!=b&&(a.value=b??""),attr:(a,b,c)=>null==b||!1===b?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b),class:(a,b)=>"string"==typeof b&&b.split(/\s+/).forEach(b=>b&&a.classList["!"===b[0]?"remove":"add"]("!"===b[0]?b.slice(1):b)),init:()=>{},destroy:()=>{}},u=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=s(d());f.$refs={},f.$root=c,f.$store=i;const g=[],h=a=>{let d=a.target;if(d._m&&("input"===a.type||"change"===a.type)){const a=d._m,b="checkbox"===d.type?d.checked:d.value,{ctx:c}=n(d._s||f,a);if(-1===a.indexOf("."))(d._s||f)[a]=b;else if(c){const d=a.split(".");c[d[d.length-1]]=b}}for(let e;d&&d!==c.parentNode;){if(e=b.get(d)?.[a.type]){const{val:b,ctx:c}=n(d._s||f,e);"function"==typeof b&&b.call(c,a)}d=d.parentNode}},j=(a,d,e)=>{if(1!==a.nodeType||a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data")){const b=u(a);return void(b&&e.push(b.unmount))}let g;if(g=a.getAttribute("s-if")){const b=document.createTextNode(""),c=[];a.replaceWith(b);let f;return e.push(()=>c.forEach(a=>a())),e.push(r(()=>{const{val:e,ctx:h}=n(d,g),i="function"==typeof e?e.call(h):e;i?!f&&(f=a.cloneNode(!0),f.removeAttribute("s-if"),j(f,d,c),b.parentNode.insertBefore(f,b)):f&&(c.forEach(a=>a()),c.length=0,f.remove(),f=null)},o))}if("TEMPLATE"===a.tagName&&(g=a.getAttribute("s-for"))){const b=g.match(/^\s*(.*?)\s+in\s+(.+)\s*$/);if(!b)return;const[c,f]=[b[1].replace(/[()]/g,""),b[2]],[h,k]=c.split(",").map(a=>a.trim()),l=a.getAttribute("s-key"),q=document.createTextNode("");a.replaceWith(q);let s=new Map;return e.push(()=>s.forEach(a=>a.k.forEach(a=>a()))),e.push(r(()=>{const{val:b}=n(d,f),c=b;Array.isArray(c)&&p(c,"length");let e=q;const g=Array.isArray(c)?c:c?Object.keys(c):[],o=new Map;g.forEach((b,f)=>{const[g,i]=Array.isArray(c)?[f,b]:[b,c[b]];let n=l&&i?i[l]:"object"==typeof i&&i?i:g+"_"+i;let p=s.get(n);const q=a=>{Object.defineProperty(a,h,{configurable:!0,enumerable:!0,get:()=>c[g],set:a=>c[g]=a})};if(!p){const b=a.content.cloneNode(!0),e=m(d),f=[];q(e),k&&(e[k]=g);const h=[];for(let a=b.firstChild;a;){h.push(a);const b=a.nextSibling;j(a,e,f),a=b}p={n:h,s:e,k:f}}else q(p.s),k&&(p.s[k]=g);if(p.n[0]!==e.nextSibling){const a=document.createDocumentFragment();p.n.forEach(b=>a.appendChild(b)),e.parentNode.insertBefore(a,e.nextSibling)}e=p.n[p.n.length-1],o.set(n,p),s.delete(n)}),s.forEach(a=>(a.k.forEach(a=>a()),a.n.forEach(a=>a.remove()))),s=o},o))}const k=a.attributes;for(let g=k.length-1;0<=g;g--){const{name:i,value:j}=k[g];if(":"===i[0])e.push(r(()=>{const{val:b,ctx:c}=n(d,j);t["class"===i.slice(1)?"class":"attr"](a,"function"==typeof b?b.call(c):b,i.slice(1))},o));else if(i.startsWith("s-")){const g=i.slice(2);if("ref"===g)f.$refs[j]=a;else if("model"!==g)t[g]?e.push(r(()=>{const{val:b,ctx:c}=n(d,j);t[g](a,"function"==typeof b?b.call(c):b)},o)):(a._s=d,(b.get(a)??b.set(a,{}).get(a))[g]=j,!c._e?.has(g)&&(c._e??=new Set).add(g)&&c.addEventListener(g,h));else if(e.push(r(()=>{const{val:b}=n(d,j);t.value(a,b)},o)),/^(INPUT|SELECT|TEXTAREA)$/.test(a.tagName)){a._s=d,a._m=j;const b="checkbox"===a.type||"radio"===a.type||"SELECT"===a.tagName?"change":"input";!c._e?.has(b)&&(c._e??=new Set).add(b)&&c.addEventListener(b,h)}}}for(let b=a.firstElementChild;b;){const a=b.nextElementSibling;j(b,d,e),b=a}};return j(c,f,g),f.init?.(),{unmount:()=>(f.destroy?.call(f),g.forEach(a=>a()),c._e?.forEach(a=>c.removeEventListener(a,h)),c._m=0)}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(u),store:(a,b)=>b===void 0?i[a]:i[a]=b}})();export default spiki;
