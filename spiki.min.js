const spiki=(()=>{const a=Object.create(null),[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Set;let f,g,h=Promise.resolve();const i=(a,b,c,d=!0)=>{let e=a;if(b.includes(".")){for(const a of b.split("."))if(e=e?.[a],void 0===e)return;}else e=a[b];return d&&"function"==typeof e?e.call(a,c):e},j=a=>!e.has(a)&&e.add(a)&&!g&&(g=!0)&&h.then(()=>(e.forEach(a=>a()),e.clear(),g=!1)),l=(a,b)=>{if(!f)return;let d=c.get(a)||c.set(a,new Map).get(a),e=d.get(b)||d.set(b,new Set).get(b);e.add(f),f.d.add(e)},m=(a,b)=>c.get(a)?.get(b)?.forEach(a=>a.x?a.x(a):a()),n=a=>(a.d.forEach(b=>b.delete(a)),a.d.clear()),o=(a,b)=>{const c=()=>{n(c);const b=f;f=c;try{a()}finally{f=b}};return c.d=new Set,c.x=b,c(),()=>n(c)},p=a=>!a||"object"!=typeof a||a._p||a instanceof Node?a:d.get(a)||d.set(a,new Proxy(a,{get(a,b,c){if("_p"===b)return!0;l(a,b);const d=Reflect.get(a,b,c);return d&&"object"==typeof d&&!(d instanceof Node)?p(d):d},set(a,b,c,d){const e=a[b],f=Reflect.set(a,b,c,d);return e!==c&&(m(a,b),Array.isArray(a)&&"length"!==b&&m(a,"length")),f}})).get(a),q={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value=b??"",attr:(a,b,c)=>null==b||!1===b?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b),class:(a,b)=>{"string"==typeof b&&b.split(/\s+/).forEach(b=>{b&&("!"===b[0]?a.classList.remove(b.slice(1)):a.classList.add(b))})},init:()=>{}},r=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=p(d());f.$refs={};const g=[],h=(a,b)=>b.push(o(a,j)),l=a=>{for(let d=a.target;d&&d!==c.parentNode;){const c=b.get(d)?.[a.type];if(c){const b=i(d._s||f,c,null,!1);"function"==typeof b&&b.call(d._s||f,a)}d=d.parentNode}},m=(a,d,e)=>{if(1!==a.nodeType||a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data"))return void r(a);let g;if(g=a.getAttribute("s-if")){const b=document.createTextNode("");a.replaceWith(b);let c,f=[];return void h(()=>{i(d,g)?!c&&(c=a.cloneNode(!0),c.removeAttribute("s-if"),m(c,d,f),b.parentNode.insertBefore(c,b)):c&&(f.forEach(a=>a()),f.length=0,c.remove(),c=null)},e)}if("TEMPLATE"===a.tagName&&(g=a.getAttribute("s-for"))){const b=g.match(/^\s*(.*?)\s+in\s+(.+)\s*$/);if(!b)return;const[c,f]=[b[1].replace(/[()]/g,""),b[2]],[j,k]=c.split(",").map(a=>a.trim()),l=document.createTextNode("");a.replaceWith(l);let n=new Map;return void h(()=>{const b=i(d,f),c=new Map;let e=l;const g=Array.isArray(b)?b:b?Object.keys(b):[];g.forEach((f,g)=>{const[h,i]=Array.isArray(b)?[g,f]:[f,b[f]],l="object"==typeof i&&null!==i?i:h+"_"+i;let o=n.get(l);if(!o){const b=a.content.cloneNode(!0),e=Object.create(d);e[j]=i,k&&(e[k]=h);const c=Array.from(b.childNodes),f=[];c.forEach(a=>m(a,e,f)),o={n:c,s:e,k:f}}else o.s[j]=i,k&&(o.s[k]=h);if(o.n[0]!==e.nextSibling){const a=document.createDocumentFragment();o.n.forEach(b=>a.appendChild(b)),e.parentNode.insertBefore(a,e.nextSibling)}e=o.n[o.n.length-1],c.set(l,o),n.delete(l)}),n.forEach(a=>(a.k.forEach(a=>a()),a.n.forEach(a=>a.remove()))),n=c},e)}const j=a.attributes;for(let g=j.length-1;0<=g;g--){const{name:k,value:m}=j[g];if(":"===k[0]){const b=k.slice(1);h(()=>q["class"===b?"class":"attr"](a,i(d,m,a),b),e)}else if("s"===k[0]&&"-"===k[1]){const g=k.slice(2);"ref"===g?f.$refs[m]=a:q[g]?h(()=>q[g](a,i(d,m,a)),e):(a._s=d,(b.get(a)||b.set(a,{}).get(a))[g]=m,!c._e?.has(g)&&((c._e||=new Set).add(g),c.addEventListener(g,l)))}}for(let b=a.firstElementChild;b;)m(b,d,e),b=b.nextElementSibling};return m(c,f,g),f.init&&f.init(),{unmount:()=>(g.forEach(a=>a()),c._m=0)}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(r)}})();export default spiki;
