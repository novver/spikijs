let spiki=(()=>{let e=Object.create(null),[t,r,l]=[new WeakMap,new WeakMap,new WeakMap],n=/^\s*(.*?)\s+in\s+(.+)\s*$/,i=new Set,a,s,o=Promise.resolve(),f=(e,t)=>{if(!t.includes("."))return e[t];let r=t.split(".");for(let l=0;l<r.length;l++)if(void 0===(e=e?.[r[l]]))return;return e},c=e=>!i.has(e)&&i.add(e)&&!s&&(s=!0)&&o.then(()=>(i.forEach(e=>e()),i.clear(),s=!1)),u=(e,t)=>{if(!a)return;let l=r.get(e);l||r.set(e,l=new Map);let n=l.get(t);n||l.set(t,n=new Set),n.add(a),a.d.add(n)},d=(e,t)=>{let l=r.get(e)?.get(t);l&&[...l].forEach(e=>e.x?e.x(e):e())},h=e=>(e.d.forEach(t=>t.delete(e)),e.d.clear()),g=(e,t)=>{let r=()=>{h(r);let t=a;a=r;try{e()}finally{a=t}};return r.d=new Set,r.x=t,r(),()=>h(r)},p=e=>{if(!e||"object"!=typeof e||e._p||e instanceof Node)return e;if(l.has(e))return l.get(e);let t=new Proxy(e,{get(e,t,r){if("_p"===t)return!0;u(e,t);let l=Reflect.get(e,t,r);return"object"!=typeof l||!l||l instanceof Node?l:p(l)},set(e,t,r,l){let n=e[t],i=Reflect.set(e,t,r,l);return n!==r&&(d(e,t),Array.isArray(e)&&"length"!==t&&d(e,"length")),i}});return l.set(e,t),t},m={text:(e,t)=>e.textContent=t??"",html:(e,t)=>e.innerHTML=t??"",value(e,t){"checkbox"===e.type?e.checked=!!t:"radio"===e.type&&e.name?e.checked=e.value==t:e.value=t??""},class:(e,t)=>e.className=(e._oc??=e.className)+(t?" "+t:""),attr(e,t,r){!1===t||null==t?e.removeAttribute(r):e.setAttribute(r,!0===t?"":t)}},b=r=>{if(r._m)return;r._m=1;let l=e[r.getAttribute("s-data")];if(!l)return;let i=p(l());i.$refs={};let a=[],s=e=>{let l=e.target;for(;l&&l!==r.parentNode;){let n=t.get(l)?.[e.type];if(n){let a=l._s||i,s=f(a,n);"function"==typeof s&&s.call(a,e)}l=l.parentNode}},o=(e,t)=>t.push(g(e,c)),u=(e,l,a)=>{if(1!==e.nodeType||e.hasAttribute("s-ignore")||e!==r&&e.hasAttribute("s-data"))return;let c;if(c=e.getAttribute("s-if")){let d=document.createTextNode("");e.replaceWith(d);let h,g=[];o(()=>{if(f(l,c))h||((h=e.cloneNode(!0)).removeAttribute("s-if"),u(h,l,g),d.parentNode.insertBefore(h,d));else if(h){for(;g.length;)g.pop()();h.remove(),h=null}},a);return}if("TEMPLATE"===e.tagName&&(c=e.getAttribute("s-for"))){let p=c.match(n);if(!p)return;let b=p[1].replace(/[()]/g,""),y=p[2],[E,x]=b.split(",").map(e=>e.trim()),A=document.createTextNode("");e.replaceWith(A);let N=new Map;o(()=>{let t=f(l,y),r=new Map,n=A,i=Array.isArray(t),a=i?t:t?Object.keys(t):[];for(let s=0;s<a.length;s++){let o=i?s:a[s],c=i?a[s]:t[o],d="object"==typeof c&&null!==c?c:o+"_"+c,h=N.get(d);if(h)h.s[E]=c,x&&(h.s[x]=o);else{let g=e.content.cloneNode(!0),p=Object.create(l);p[E]=c,x&&(p[x]=o);let m=Array.from(g.childNodes),b=[];for(let $=0;$<m.length;$++)u(m[$],p,b);h={n:m,s:p,k:b}}if(h.n[0]!==n.nextSibling){let w=document.createDocumentFragment();h.n.forEach(e=>w.appendChild(e)),n.parentNode.insertBefore(w,n.nextSibling)}n=h.n[h.n.length-1],r.set(d,h),N.delete(d)}N.forEach(e=>{e.k.forEach(e=>e()),e.n.forEach(e=>e.remove())}),N=r},a);return}let $=e.attributes;for(let w=$.length-1;w>=0;w--){let{name:v,value:k}=$[w];if(v.startsWith(":")){let _=v.slice(1),T="class"===_?m.class:m.attr;o(()=>T(e,f(l,k),_),a)}else if(v.startsWith("s-")){let S=v.slice(2);if("ref"===S)i.$refs[k]=e;else if(m[S])o(()=>m[S](e,f(l,k)),a);else{e._s=l;let W=t.get(e);W||t.set(e,W={}),W[S]=k,r._e||(r._e=new Set),r._e.has(S)||(r.addEventListener(S,s),r._e.add(S))}}}let j=e.firstElementChild;for(;j;){let C=j.nextElementSibling;u(j,l,a),j=C}};return u(r,i,a),i.init&&i.init(),{unmount(){a.forEach(e=>e()),r._m=0}}};return{data:(t,r)=>e[t]=r,start:()=>document.querySelectorAll("[s-data]").forEach(b)}})();export default spiki;
