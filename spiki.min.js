const spiki=(()=>{const a=Object.create(null),[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Map,f=new Set;let g,h,i,j=Promise.resolve(),l=!0;const m={};["sort","reverse","splice"].forEach(a=>{const b=Array.prototype[a];m[a]=function(...a){l=!1;const c=b.apply(this,a);return l=!0,q(this,"length"),c}});const n=(a,b,c,d=!0)=>{if(-1===b.indexOf(".")){const e=a[b];return d&&"function"==typeof e?e.call(a,c):e}let f=e.get(b);f||(500<e.size&&e.clear(),e.set(b,f=b.split(".")));let g=a;for(const e of f)if((g=g?.[e])===void 0)return;return d&&"function"==typeof g?g.call(a,c):g},o=a=>!f.has(a)&&f.add(a)&&!h&&(h=!0)&&j.then(()=>(f.forEach(a=>a()),f.clear(),h=!1)),p=(a,b)=>{if(!g)return;let d=c.get(a);d||c.set(a,d=new Map);let e=d.get(b);e||d.set(b,e=new Set),e.add(g),g.d.add(e)},q=(a,b)=>{l&&c.get(a)?.get(b)?.forEach(a=>a.x?a.x(a):a())},r=(a,b)=>{const c=()=>{c.d.forEach(a=>a.delete(c)),c.d.clear();const b=g;g=c;try{a()}finally{g=b}};return c.d=new Set,c.x=b,c(),()=>{c.d.forEach(a=>a.delete(c)),c.d.clear(),f.delete(c)}},s=a=>!a||"object"!=typeof a||a._p||a instanceof Node?a:d.get(a)||d.set(a,new Proxy(a,{get:(a,b,c)=>{if("_p"===b)return!0;if(Array.isArray(a)&&m.hasOwnProperty(b))return m[b];p(a,b);const d=Reflect.get(a,b,c);return d&&"object"==typeof d&&!(d instanceof Node)?s(d):d},set:(a,b,c,d)=>{const e=a[b],f=Array.isArray(a)?+b<a.length:Object.prototype.hasOwnProperty.call(a,b),g=Reflect.set(a,b,c,d);return l&&(f?e!==c&&q(a,b):(q(a,b),Array.isArray(a)&&q(a,"length"))),g}})).get(a);i=s({});const t={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>{"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value!=b&&(a.value=b??"")},attr:(a,b,c)=>null==b||!1===b?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b),class:(a,b)=>"string"==typeof b&&b.split(/\s+/).forEach(b=>b&&("!"===b[0]?a.classList.remove(b.slice(1)):a.classList.add(b))),init:()=>{},destroy:()=>{}},u=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=s(d());f.$refs={},f.$root=c,f.$store=i;const g=(a,b)=>b.push(r(a,o)),h=a=>{let d=a.target;if(d._m&&("input"===a.type||"change"===a.type)){const a=d._s||f,b=d._m,c="checkbox"===d.type?d.checked:d.value;if(-1<b.indexOf(".")){const d=e.get(b)||b.split(".");e.has(b)||e.set(b,d);let f=a;for(let a=0;a<d.length-1;a++)f=f[d[a]];f[d[d.length-1]]=c}else a[b]=c}for(let e;d&&d!==c.parentNode;){if(e=b.get(d)?.[a.type]){const b=n(d._s||f,e,null,!1);"function"==typeof b&&b.call(d._s||f,a)}d=d.parentNode}},j=(a,d,e)=>{if(1!==a.nodeType||a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data")){const b=u(a);return void(b&&e.push(b.unmount))}let i;if(i=a.getAttribute("s-if")){const b=document.createTextNode(""),c=[];a.replaceWith(b);let f;return g(()=>{n(d,i)?!f&&(f=a.cloneNode(!0),f.removeAttribute("s-if"),j(f,d,c),b.parentNode.insertBefore(f,b)):f&&(c.forEach(a=>a()),c.length=0,f.remove(),f=null)},e)}if("TEMPLATE"===a.tagName&&(i=a.getAttribute("s-for"))){const b=i.match(/^\s*(.*?)\s+in\s+(.+)\s*$/);if(!b)return;const[c,f]=[b[1].replace(/[()]/g,""),b[2]],[h,k]=c.split(",").map(a=>a.trim()),l=document.createTextNode("");a.replaceWith(l);let m=new Map;return g(()=>{const b=n(d,f),c=new Map;Array.isArray(b)&&p(b,"length");let e=l;const g=Array.isArray(b)?b:b?Object.keys(b):[];g.forEach((f,g)=>{const[i,l]=Array.isArray(b)?[g,f]:[f,b[f]],n="object"==typeof l&&l?l:i+"_"+l;let o=m.get(n);if(!o){const b=a.content.cloneNode(!0),e=Object.create(d),f=[];e[h]=l,k&&(e[k]=i);const g=[];for(let a=b.firstChild;a;){g.push(a);const b=a.nextSibling;j(a,e,f),a=b}o={n:g,s:e,k:f}}else o.s[h]=l,k&&(o.s[k]=i);if(o.n[0]!==e.nextSibling){const a=document.createDocumentFragment();o.n.forEach(b=>a.appendChild(b)),e.parentNode.insertBefore(a,e.nextSibling)}e=o.n[o.n.length-1],c.set(n,o),m.delete(n)}),m.forEach(a=>(a.k.forEach(a=>a()),a.n.forEach(a=>a.remove()))),m=c},e)}const k=a.attributes;for(let j=k.length-1;0<=j;j--){const{name:i,value:l}=k[j],m=i[0];if(":"===m){const b=i.slice(1);g(()=>t["class"===b?"class":"attr"](a,n(d,l,a),b),e)}else if("s"===m&&"-"===i[1]){const j=i.slice(2);if("ref"===j)f.$refs[l]=a;else if("model"===j){g(()=>t.value(a,n(d,l,a)),e);const b=a.tagName;if("INPUT"===b||"SELECT"===b||"TEXTAREA"===b){a._s=d,a._m=l;const e="checkbox"===a.type||"radio"===a.type||"SELECT"===b?"change":"input";c._e?.has(e)||((c._e??=new Set).add(e),c.addEventListener(e,h))}}else t[j]?g(()=>t[j](a,n(d,l,a)),e):(a._s=d,(b.get(a)??b.set(a,{}).get(a))[j]=l,c._e?.has(j)||((c._e??=new Set).add(j),c.addEventListener(j,h)))}}for(let b=a.firstElementChild;b;){const a=b.nextElementSibling;j(b,d,e),b=a}},k=[];return j(c,f,k),f.init&&f.init(),{unmount:()=>{f.destroy&&f.destroy.call(f),k.forEach(a=>a()),c._e?.forEach(a=>c.removeEventListener(a,h)),c._m=0}}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(u),store:(a,b)=>void 0===b?i[a]:(i[a]=b,i[a])}})();export default spiki;
