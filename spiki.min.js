const spiki=(()=>{const a=Object.create(null),[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Set;let f,g,h=Promise.resolve();const i=(a,b,c,d=!0)=>{let e=a;if(-1<b.indexOf(".")){for(const a of b.split("."))if(void 0===(e=e?.[a]))return;}else e=a[b];return d&&"function"==typeof e?e.call(a,c):e},j=a=>!e.has(a)&&e.add(a)&&!g&&(g=!0)&&h.then(()=>(e.forEach(a=>a()),e.clear(),g=!1)),l=(a,b)=>{if(f){let d=(c.get(a)||c.set(a,new Map).get(a)).get(b)||c.get(a).set(b,new Set).get(b);d.add(f),f.d.add(d)}},m=(a,b)=>c.get(a)?.get(b)?.forEach(a=>a.x?a.x(a):a()),n=(a,b)=>{const c=()=>{c.d.forEach(a=>a.delete(c)),c.d.clear();const b=f;f=c;try{a()}finally{f=b}};return c.d=new Set,c.x=b,c(),()=>(c.d.forEach(a=>a.delete(c)),c.d.clear())},o=a=>!a||"object"!=typeof a||a._p||a instanceof Node?a:d.get(a)||d.set(a,new Proxy(a,{get:(a,b,c)=>"_p"===b||(l(a,b),(a=>a&&"object"==typeof a&&!(a instanceof Node)?o(a):a)(Reflect.get(a,b,c))),set:(a,b,c,d)=>{const e=a[b],f=Reflect.set(a,b,c,d);return e!==c&&(m(a,b),Array.isArray(a)&&"length"!==b&&m(a,"length")),f}})).get(a),p={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value=b??"",attr:(a,b,c)=>null==b||!1===b?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b),class:(a,b)=>"string"==typeof b&&b.split(/\s+/).forEach(b=>b&&("!"===b[0]?a.classList.remove(b.slice(1)):a.classList.add(b))),init:()=>{}},q=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=o(d());f.$refs={};const g=(a,b)=>b.push(n(a,j)),h=a=>{for(let d,e=a.target;e&&e!==c.parentNode;){if(d=b.get(e)?.[a.type]){const b=i(e._s||f,d,null,!1);"function"==typeof b&&b.call(e._s||f,a)}e=e.parentNode}},k=(a,d,e)=>{if(1!==a.nodeType||a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data"))return q(a);let j;if(j=a.getAttribute("s-if")){const b=document.createTextNode(""),c=[];a.replaceWith(b);let f;return g(()=>{i(d,j)?!f&&(f=a.cloneNode(!0),f.removeAttribute("s-if"),k(f,d,c),b.parentNode.insertBefore(f,b)):f&&(c.forEach(a=>a()),c.length=0,f.remove(),f=null)},e)}if("TEMPLATE"===a.tagName&&(j=a.getAttribute("s-for"))){const b=j.match(/^\s*(.*?)\s+in\s+(.+)\s*$/);if(!b)return;const[c,f]=[b[1].replace(/[()]/g,""),b[2]],[h,l]=c.split(",").map(a=>a.trim()),m=document.createTextNode("");a.replaceWith(m);let n=new Map;return g(()=>{const b=i(d,f),c=new Map;let e=m;const g=Array.isArray(b)?b:b?Object.keys(b):[];g.forEach((f,g)=>{const[i,j]=Array.isArray(b)?[g,f]:[f,b[f]],m="object"==typeof j&&j?j:i+"_"+j;let o=n.get(m);if(!o){const b=a.content.cloneNode(!0),e=Object.create(d),f=[];e[h]=j,l&&(e[l]=i),Array.from(b.childNodes).forEach(a=>k(a,e,f)),o={n:Array.from(b.childNodes),s:e,k:f}}else o.s[h]=j,l&&(o.s[l]=i);if(o.n[0]!==e.nextSibling){const a=document.createDocumentFragment();o.n.forEach(b=>a.appendChild(b)),e.parentNode.insertBefore(a,e.nextSibling)}e=o.n[o.n.length-1],c.set(m,o),n.delete(m)}),n.forEach(a=>(a.k.forEach(a=>a()),a.n.forEach(a=>a.remove()))),n=c},e)}const l=a.attributes;for(let j=l.length-1;0<=j;j--){const{name:k,value:m}=l[j];if(":"===k[0])g(()=>p["class"===k.slice(1)?"class":"attr"](a,i(d,m,a),k.slice(1)),e);else if("s"===k[0]&&"-"===k[1]){const j=k.slice(2);if("ref"===j)f.$refs[m]=a;else if("model"===j){g(()=>p.value(a,i(d,m,a)),e);const b=a.tagName;if("INPUT"===b||"SELECT"===b||"TEXTAREA"===b){const c="checkbox"===a.type||"radio"===a.type;a.addEventListener(c||"SELECT"===b?"change":"input",()=>{let b="checkbox"===a.type?a.checked:a.value,c=d,e=m.split(".");if(1<e.length){for(let a=0;a<e.length-1;a++)c=c[e[a]];c[e[e.length-1]]=b}else d[m]=b})}}else p[j]?g(()=>p[j](a,i(d,m,a)),e):(a._s=d,(b.get(a)||b.set(a,{}).get(a))[j]=m,(c._e||=new Set).add(j)&&c.addEventListener(j,h))}}for(let b=a.firstElementChild;b;)k(b,d,e),b=b.nextElementSibling},l=[];return k(c,f,l),f.init&&f.init(),{unmount:()=>(l.forEach(a=>a()),c._m=0)}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(q)}})();export default spiki;
