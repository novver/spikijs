const spiki=(()=>{const a=Object.create(null),[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Map,f=new Set;let g,h,i,j=Promise.resolve();const k=(a,b,c,d=!0)=>{if(-1===b.indexOf(".")){const e=a[b];return d&&"function"==typeof e?e.call(a,c):e}let f=e.get(b);f||e.set(b,f=b.split("."));let g=a;for(const e of f)if((g=g?.[e])===void 0)return;return d&&"function"==typeof g?g.call(a,c):g},l=a=>!f.has(a)&&f.add(a)&&!h&&(h=!0)&&j.then(()=>(f.forEach(a=>a()),f.clear(),h=!1)),m=(a,b)=>{if(!g)return;let d=c.get(a);d||c.set(a,d=new Map);let e=d.get(b);e||d.set(b,e=new Set),e.add(g),g.d.add(e)},n=(a,b)=>c.get(a)?.get(b)?.forEach(a=>a.x?a.x(a):a()),o=(a,b)=>{const c=()=>{c.d.forEach(a=>a.delete(c)),c.d.clear();const b=g;g=c;try{a()}finally{g=b}};return c.d=new Set,c.x=b,c(),()=>(c.d.forEach(a=>a.delete(c)),c.d.clear())},p=a=>!a||"object"!=typeof a||a._p||a instanceof Node?a:d.get(a)||d.set(a,new Proxy(a,{get:(a,b,c)=>"_p"===b||(m(a,b),(a=>a&&"object"==typeof a&&!(a instanceof Node)?p(a):a)(Reflect.get(a,b,c))),set:(a,b,c,d)=>{const e=a[b],f=Reflect.set(a,b,c,d);return e!==c&&(n(a,b),Array.isArray(a)&&"length"!==b&&n(a,"length")),f}})).get(a);i=p({});const q={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>{"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value!=b&&(a.value=b??"")},attr:(a,b,c)=>null==b||!1===b?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b),class:(a,b)=>"string"==typeof b&&b.split(/\s+/).forEach(b=>b&&("!"===b[0]?a.classList.remove(b.slice(1)):a.classList.add(b))),init:()=>{},destroy:()=>{}},r=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=p(d());f.$refs={},f.$root=c,f.$store=i;const g=(a,b)=>b.push(o(a,l)),h=a=>{let d=a.target;if(d._m&&("input"===a.type||"change"===a.type)){const a=d._s||f,b=d._m,c="checkbox"===d.type?d.checked:d.value;if(-1<b.indexOf(".")){const d=e.get(b)||b.split(".");e.has(b)||e.set(b,d);let f=a;for(let a=0;a<d.length-1;a++)f=f[d[a]];f[d[d.length-1]]=c}else a[b]=c}for(let e;d&&d!==c.parentNode;){if(e=b.get(d)?.[a.type]){const b=k(d._s||f,e,null,!1);"function"==typeof b&&b.call(d._s||f,a)}d=d.parentNode}},j=(a,d,e)=>{if(1!==a.nodeType||a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data")){const b=r(a);return void(b&&e.push(b.unmount))}let i;if(i=a.getAttribute("s-if")){const b=document.createTextNode(""),c=[];a.replaceWith(b);let f;return g(()=>{k(d,i)?!f&&(f=a.cloneNode(!0),f.removeAttribute("s-if"),j(f,d,c),b.parentNode.insertBefore(f,b)):f&&(c.forEach(a=>a()),c.length=0,f.remove(),f=null)},e)}if("TEMPLATE"===a.tagName&&(i=a.getAttribute("s-for"))){const b=i.match(/^\s*(.*?)\s+in\s+(.+)\s*$/);if(!b)return;const[c,f]=[b[1].replace(/[()]/g,""),b[2]],[h,l]=c.split(",").map(a=>a.trim()),m=document.createTextNode("");a.replaceWith(m);let n=new Map;return g(()=>{const b=k(d,f),c=new Map;let e=m;const g=Array.isArray(b)?b:b?Object.keys(b):[];g.forEach((f,g)=>{const[i,k]=Array.isArray(b)?[g,f]:[f,b[f]],m="object"==typeof k&&k?k:i+"_"+k;let o=n.get(m);if(!o){const b=a.content.cloneNode(!0),e=Object.create(d),f=[];e[h]=k,l&&(e[l]=i);const g=[];for(let a=b.firstChild;a;){g.push(a);const b=a.nextSibling;j(a,e,f),a=b}o={n:g,s:e,k:f}}else o.s[h]=k,l&&(o.s[l]=i);if(o.n[0]!==e.nextSibling){const a=document.createDocumentFragment();o.n.forEach(b=>a.appendChild(b)),e.parentNode.insertBefore(a,e.nextSibling)}e=o.n[o.n.length-1],c.set(m,o),n.delete(m)}),n.forEach(a=>(a.k.forEach(a=>a()),a.n.forEach(a=>a.remove()))),n=c},e)}const l=a.attributes;for(let j=l.length-1;0<=j;j--){const{name:i,value:m}=l[j],n=i[0];if(":"===n){const b=i.slice(1);g(()=>q["class"===b?"class":"attr"](a,k(d,m,a),b),e)}else if("s"===n&&"-"===i[1]){const j=i.slice(2);if("ref"===j)f.$refs[m]=a;else if("model"===j){g(()=>q.value(a,k(d,m,a)),e);const b=a.tagName;if("INPUT"===b||"SELECT"===b||"TEXTAREA"===b){a._s=d,a._m=m;const e="checkbox"===a.type||"radio"===a.type,f=e||"SELECT"===b?"change":"input";c._e?.has(f)||((c._e??=new Set).add(f),c.addEventListener(f,h))}}else q[j]?g(()=>q[j](a,k(d,m,a)),e):(a._s=d,(b.get(a)??b.set(a,{}).get(a))[j]=m,c._e?.has(j)||((c._e??=new Set).add(j),c.addEventListener(j,h)))}}for(let b=a.firstElementChild;b;){const a=b.nextElementSibling;j(b,d,e),b=a}},m=[];return j(c,f,m),f.init&&f.init(),{unmount:()=>{f.destroy&&f.destroy.call(f),m.forEach(a=>a()),c._e?.forEach(a=>c.removeEventListener(a,h)),c._m=0}}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(r),store:(a,b)=>void 0===b?i[a]:(i[a]=b,i[a])}})();export default spiki;
