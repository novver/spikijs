const spiki=(()=>{const a={},[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Set;let f,g,h=Promise.resolve();const i=(a,b)=>b.includes(".")?b.split(".").reduce((a,b)=>a?.[b],a):a[b],j=a=>!e.has(a)&&e.add(a)&&!g&&(g=!0)&&h.then(()=>(e.forEach(a=>a()),e.clear(),g=!1)),l=(a,b)=>{if(!f)return;let d=c.get(a);d||c.set(a,d=new Map);let e=d.get(b);e||d.set(b,e=new Set),e.add(f),f.d.add(e)},m=(a,b)=>{const d=c.get(a)?.get(b);d&&[...d].forEach(a=>a.x?a.x(a):a())},n=a=>(a.d.forEach(b=>b.delete(a)),a.d.clear()),o=(a,b)=>{const c=()=>{n(c);const b=f;f=c;try{a()}finally{f=b}};return c.d=new Set,c.x=b,c(),()=>n(c)},p=a=>{if(!a||"object"!=typeof a||a._p||a instanceof Node)return a;if(d.has(a))return d.get(a);const b=new Proxy(a,{get(a,b,c){if("_p"===b)return!0;l(a,b);const d=Reflect.get(a,b,c);return"object"==typeof d&&d?d instanceof Node?d:p(d):d},set(a,b,c,d){const e=a[b],f=Array.isArray(a)&&!isNaN(parseInt(b))?+b<a.length:b in a,g=Reflect.set(a,b,c,d);return e===c&&f||(m(a,b),Array.isArray(a)&&"length"!==b&&m(a,"length")),g}});return d.set(a,b),b},q={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>{"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value=b??""},class:(a,b,c)=>(c&&"string"==typeof c&&c.split(/\s+/).forEach(b=>b&&a.classList.remove(b)),b&&"string"==typeof b?(b.split(/\s+/).forEach(b=>b&&a.classList.add(b)),b):""),attr:(a,b,c)=>{!1===b||null===b||b===void 0?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b)}},r=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=p(d());f.$refs={};const g=[],h=a=>{for(let d=a.target;d&&d!==c.parentNode;){const c=b.get(d),e=c?.[a.type];if(e){const b=d._s||f,c=i(b,e);"function"==typeof c&&c.call(b,a)}d=d.parentNode}},l=(a,b)=>b.push(o(a,j)),m=(a,d,e)=>{if(1!==a.nodeType)return;if(a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data"))return;let g;if(g=a.getAttribute("s-if")){const b=document.createTextNode("");a.replaceWith(b);let c,f=[];return void l(()=>{if(i(d,g))c||(c=a.cloneNode(!0),c.removeAttribute("s-if"),m(c,d,f),b.parentNode.insertBefore(c,b));else if(c){for(;f.length;)f.pop()();c.remove(),c=null}},e)}if("TEMPLATE"===a.tagName&&(g=a.getAttribute("s-for"))){const[,b,c]=g.match(/^\s*(\w+)\s+in\s+(\S+)\s*$/)||[],f=document.createTextNode("");a.replaceWith(f);let h=new Map;return void l(()=>{const e=i(d,c)||[],g=new Map;let j=f;Array.isArray(e)&&e.forEach((c,e)=>{const f="object"==typeof c&&null!==c?c:`${e}_${c}`;let i=h.get(f);if(!i){const f=a.content.cloneNode(!0),g=Object.create(d);Object.assign(g,{[b]:c,$index:e,$parent:d});const h=Array.from(f.childNodes),j=[];h.forEach(a=>m(a,g,j)),i={n:h,s:g,k:j}}else i.s.$index=e,i.s[b]=c;if(i.n[0]!==j.nextSibling){const a=document.createDocumentFragment();i.n.forEach(b=>a.appendChild(b)),j.parentNode.insertBefore(a,j.nextSibling)}j=i.n[i.n.length-1],g.set(f,i),h.delete(f)}),h.forEach(a=>{a.k.forEach(a=>a()),a.n.forEach(a=>a.remove())}),h=g},e)}const j=Array.from(a.attributes);for(const{name:g,value:k}of j)if(g.startsWith("@")){const e=g.slice(1);a._s=d;let f=b.get(a);f||b.set(a,f={}),f[e]=k,c._e||(c._e=new Set),c._e.has(e)||(c.addEventListener(e,h),c._e.add(e))}else if(g.startsWith(":")){const b=g.slice(1);if("class"===b){let b="";l(()=>{const c=i(d,k);b=q.class(a,c,b)},e)}else l(()=>q.attr(a,i(d,k),b),e)}else if(g.startsWith("s-")){const b=g.slice(2);"ref"===b?f.$refs[k]=a:q[b]&&l(()=>q[b](a,i(d,k)),e)}for(let b=a.firstElementChild;b;){const a=b.nextElementSibling;m(b,d,e),b=a}};return m(c,f,g),f.init&&f.init(),{unmount:()=>{g.forEach(a=>a()),c._m=0}}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(r)}})();export default spiki;
