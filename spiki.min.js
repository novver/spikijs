const spiki=(()=>{const a=Object.create(null),[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Map,f=new Set;let g,h,i,j=!0,k=Promise.resolve();const l={};["sort","reverse","splice"].forEach(a=>l[a]=function(...b){j=!1;const c=Array.prototype[a].apply(this,b);return j=!0,p(this,"length"),c});const m=(a,b,c,d=!0)=>{if(-1===b.indexOf(".")){const e=a[b];return d&&"function"==typeof e?e.call(a,c):e}let f=e.get(b);f||(500<e.size&&e.clear(),e.set(b,f=b.split(".")));let g=a;for(const e of f)if((g=g?.[e])===void 0)return;return d&&"function"==typeof g?g.call(a,c):g},n=a=>!f.has(a)&&f.add(a)&&!h&&(h=!0)&&k.then(()=>(f.forEach(a=>a()),f.clear(),h=!1)),o=(a,b)=>{if(!g)return;let d=c.get(a)??c.set(a,new Map).get(a),e=d.get(b)??d.set(b,new Set).get(b);e.add(g),g.d.add(e)},p=(a,b)=>j&&c.get(a)?.get(b)?.forEach(a=>a.x?a.x(a):a()),q=(a,b)=>{const c=()=>{c.d.forEach(a=>a.delete(c)),c.d.clear();const b=g;g=c;try{a()}finally{g=b}};return c.d=new Set,c.x=b,c(),()=>(c.d.forEach(a=>a.delete(c)),c.d.clear(),f.delete(c))},s=a=>!a||"object"!=typeof a||a._p||a instanceof Node?a:d.get(a)||d.set(a,new Proxy(a,{get:(a,b,c)=>{if("_p"===b)return!0;if(Array.isArray(a)&&l.hasOwnProperty(b))return l[b];o(a,b);const d=Reflect.get(a,b,c);return d&&"object"==typeof d&&!(d instanceof Node)?s(d):d},set:(a,b,c,d)=>{const e=a[b],f=Array.isArray(a)?+b<a.length:Object.prototype.hasOwnProperty.call(a,b),g=Reflect.set(a,b,c,d);if(j&&(f?e!==c&&p(a,b):(p(a,b),Array.isArray(a)&&p(a,"length"))));return g}})).get(a);i=s({});const t={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value!=b&&(a.value=b??""),attr:(a,b,c)=>null==b||!1===b?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b),class:(a,b)=>"string"==typeof b&&b.split(/\s+/).forEach(b=>b&&a.classList["!"===b[0]?"remove":"add"]("!"===b[0]?b.slice(1):b)),init:()=>{},destroy:()=>{}},u=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=s(d());f.$refs={},f.$root=c,f.$store=i;const g=[],h=a=>{let d=a.target;if(d._m&&("input"===a.type||"change"===a.type)){const a=d._m,b="checkbox"===d.type?d.checked:d.value;if(-1<a.indexOf(".")){const c=e.get(a)??e.set(a,a.split(".")).get(a);let g=d._s||f;for(let a=0;a<c.length-1;a++)g=g[c[a]];g[c[c.length-1]]=b}else(d._s||f)[a]=b}for(let e;d&&d!==c.parentNode;){if(e=b.get(d)?.[a.type]){const b=m(d._s||f,e,null,!1);"function"==typeof b&&b.call(d._s||f,a)}d=d.parentNode}},j=(a,d,e)=>{if(1!==a.nodeType||a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data")){const b=u(a);return void(b&&e.push(b.unmount))}let g;if(g=a.getAttribute("s-if")){const b=document.createTextNode(""),c=[];a.replaceWith(b);let f;return e.push(()=>c.forEach(a=>a())),e.push(q(()=>{m(d,g)?!f&&(f=a.cloneNode(!0),f.removeAttribute("s-if"),j(f,d,c),b.parentNode.insertBefore(f,b)):f&&(c.forEach(a=>a()),c.length=0,f.remove(),f=null)},n))}if("TEMPLATE"===a.tagName&&(g=a.getAttribute("s-for"))){const b=g.match(/^\s*(.*?)\s+in\s+(.+)\s*$/);if(!b)return;const[c,f]=[b[1].replace(/[()]/g,""),b[2]],[h,k]=c.split(",").map(a=>a.trim()),l=document.createTextNode("");a.replaceWith(l);let p=new Map;return e.push(()=>p.forEach(a=>a.k.forEach(a=>a()))),e.push(q(()=>{const b=m(d,f),c=new Map;Array.isArray(b)&&o(b,"length");let e=l;(Array.isArray(b)?b:b?Object.keys(b):[]).forEach((f,g)=>{const[i,l]=Array.isArray(b)?[g,f]:[f,b[f]],m="object"==typeof l&&l?l:i+"_"+l;let n=p.get(m);const o=a=>{Object.defineProperty(a,h,{configurable:!0,enumerable:!0,get:()=>b[i],set:a=>b[i]=a})};if(!n){const b=a.content.cloneNode(!0),e=Object.create(d),f=[];o(e),k&&(e[k]=i);const g=[];for(let a=b.firstChild;a;){g.push(a);const b=a.nextSibling;j(a,e,f),a=b}n={n:g,s:e,k:f}}else o(n.s),k&&(n.s[k]=i);if(n.n[0]!==e.nextSibling){const a=document.createDocumentFragment();n.n.forEach(b=>a.appendChild(b)),e.parentNode.insertBefore(a,e.nextSibling)}e=n.n[n.n.length-1],c.set(m,n),p.delete(m)}),p.forEach(a=>(a.k.forEach(a=>a()),a.n.forEach(a=>a.remove()))),p=c},n))}const k=a.attributes;for(let g=k.length-1;0<=g;g--){const{name:i,value:j}=k[g];if(":"===i[0])e.push(q(()=>t["class"===i.slice(1)?"class":"attr"](a,m(d,j,a),i.slice(1)),n));else if(i.startsWith("s-")){const g=i.slice(2);if("ref"===g)f.$refs[j]=a;else if("model"!==g)t[g]?e.push(q(()=>t[g](a,m(d,j,a)),n)):(a._s=d,(b.get(a)??b.set(a,{}).get(a))[g]=j,!c._e?.has(g)&&(c._e??=new Set).add(g)&&c.addEventListener(g,h));else if(e.push(q(()=>t.value(a,m(d,j,a)),n)),/^(INPUT|SELECT|TEXTAREA)$/.test(a.tagName)){a._s=d,a._m=j;const b="checkbox"===a.type||"radio"===a.type||"SELECT"===a.tagName?"change":"input";!c._e?.has(b)&&(c._e??=new Set).add(b)&&c.addEventListener(b,h)}}}for(let b=a.firstElementChild;b;){const a=b.nextElementSibling;j(b,d,e),b=a}};return j(c,f,g),f.init?.(),{unmount:()=>(f.destroy?.call(f),g.forEach(a=>a()),c._e?.forEach(a=>c.removeEventListener(a,h)),c._m=0)}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(u),store:(a,b)=>b===void 0?i[a]:i[a]=b}})();export default spiki;
