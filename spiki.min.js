const spiki=(()=>{const a=Object.create(null),[b,c,d]=[new WeakMap,new WeakMap,new WeakMap],e=new Map,f=new Set;let g,h,i=Promise.resolve();const j=(a,b,c,d=!0)=>{if(-1===b.indexOf(".")){const e=a[b];return d&&"function"==typeof e?e.call(a,c):e}let f=e.get(b);f||e.set(b,f=b.split("."));let g=a;for(const e of f)if((g=g?.[e])===void 0)return;return d&&"function"==typeof g?g.call(a,c):g},k=a=>!f.has(a)&&f.add(a)&&!h&&(h=!0)&&i.then(()=>(f.forEach(a=>a()),f.clear(),h=!1)),l=(a,b)=>{if(!g)return;let d=c.get(a);d||c.set(a,d=new Map);let e=d.get(b);e||d.set(b,e=new Set),e.add(g),g.d.add(e)},m=(a,b)=>c.get(a)?.get(b)?.forEach(a=>a.x?a.x(a):a()),n=(a,b)=>{const c=()=>{c.d.forEach(a=>a.delete(c)),c.d.clear();const b=g;g=c;try{a()}finally{g=b}};return c.d=new Set,c.x=b,c(),()=>(c.d.forEach(a=>a.delete(c)),c.d.clear())},o=a=>!a||"object"!=typeof a||a._p||a instanceof Node?a:d.get(a)||d.set(a,new Proxy(a,{get:(a,b,c)=>"_p"===b||(l(a,b),(a=>a&&"object"==typeof a&&!(a instanceof Node)?o(a):a)(Reflect.get(a,b,c))),set:(a,b,c,d)=>{const e=a[b],f=Reflect.set(a,b,c,d);return e!==c&&(m(a,b),Array.isArray(a)&&"length"!==b&&m(a,"length")),f}})).get(a),p={text:(a,b)=>a.textContent=b??"",html:(a,b)=>a.innerHTML=b??"",value:(a,b)=>{"checkbox"===a.type?a.checked=!!b:"radio"===a.type&&a.name?a.checked=a.value==b:a.value!=b&&(a.value=b??"")},attr:(a,b,c)=>null==b||!1===b?a.removeAttribute(c):a.setAttribute(c,!0===b?"":b),class:(a,b)=>"string"==typeof b&&b.split(/\s+/).forEach(b=>b&&("!"===b[0]?a.classList.remove(b.slice(1)):a.classList.add(b))),init:()=>{},destroy:()=>{}},q=c=>{if(c._m)return;c._m=1;const d=a[c.getAttribute("s-data")];if(!d)return;const f=o(d());f.$refs={},f.$root=c;const g=(a,b)=>b.push(n(a,k)),h=a=>{for(let d,e=a.target;e&&e!==c.parentNode;){if(d=b.get(e)?.[a.type]){const b=j(e._s||f,d,null,!1);"function"==typeof b&&b.call(e._s||f,a)}e=e.parentNode}},i=(a,d,e)=>{if(1!==a.nodeType||a.hasAttribute("s-ignore"))return;if(a!==c&&a.hasAttribute("s-data")){const b=q(a);return void(b&&e.push(b.unmount))}let k;if(k=a.getAttribute("s-if")){const b=document.createTextNode(""),c=[];a.replaceWith(b);let f;return g(()=>{j(d,k)?!f&&(f=a.cloneNode(!0),f.removeAttribute("s-if"),i(f,d,c),b.parentNode.insertBefore(f,b)):f&&(c.forEach(a=>a()),c.length=0,f.remove(),f=null)},e)}if("TEMPLATE"===a.tagName&&(k=a.getAttribute("s-for"))){const b=k.match(/^\s*(.*?)\s+in\s+(.+)\s*$/);if(!b)return;const[c,f]=[b[1].replace(/[()]/g,""),b[2]],[h,l]=c.split(",").map(a=>a.trim()),m=document.createTextNode("");a.replaceWith(m);let n=new Map;return g(()=>{const b=j(d,f),c=new Map;let e=m;const g=Array.isArray(b)?b:b?Object.keys(b):[];g.forEach((f,g)=>{const[j,k]=Array.isArray(b)?[g,f]:[f,b[f]],m="object"==typeof k&&k?k:j+"_"+k;let o=n.get(m);if(!o){const b=a.content.cloneNode(!0),e=Object.create(d),f=[];e[h]=k,l&&(e[l]=j);const g=[];for(let a=b.firstChild;a;){g.push(a);const b=a.nextSibling;i(a,e,f),a=b}o={n:g,s:e,k:f}}else o.s[h]=k,l&&(o.s[l]=j);if(o.n[0]!==e.nextSibling){const a=document.createDocumentFragment();o.n.forEach(b=>a.appendChild(b)),e.parentNode.insertBefore(a,e.nextSibling)}e=o.n[o.n.length-1],c.set(m,o),n.delete(m)}),n.forEach(a=>(a.k.forEach(a=>a()),a.n.forEach(a=>a.remove()))),n=c},e)}const l=a.attributes;for(let k=l.length-1;0<=k;k--){const{name:i,value:m}=l[k],n=i[0];if(":"===n){const b=i.slice(1);g(()=>p["class"===b?"class":"attr"](a,j(d,m,a),b),e)}else if("s"===n&&"-"===i[1]){const k=i.slice(2);if("ref"===k)f.$refs[m]=a;else if("model"===k){g(()=>p.value(a,j(d,m,a)),e);const b=a.tagName;if("INPUT"===b||"SELECT"===b||"TEXTAREA"===b){const c="checkbox"===a.type||"radio"===a.type,f=c||"SELECT"===b?"change":"input",g=()=>{const b="checkbox"===a.type?a.checked:a.value;if(-1<m.indexOf(".")){const a=m.split("."),c=a.pop();let e=d;for(const b of a)e=e[b];e[c]=b}else d[m]=b};a.addEventListener(f,g),e.push(()=>a.removeEventListener(f,g))}}else p[k]?g(()=>p[k](a,j(d,m,a)),e):(a._s=d,(b.get(a)??b.set(a,{}).get(a))[k]=m,c._e?.has(k)||((c._e??=new Set).add(k),c.addEventListener(k,h)))}}for(let b=a.firstElementChild;b;){const a=b.nextElementSibling;i(b,d,e),b=a}},l=[];return i(c,f,l),f.init&&f.init(),{unmount:()=>{f.destroy&&f.destroy.call(f),l.forEach(a=>a()),c._e?.forEach(a=>c.removeEventListener(a,h)),c._m=0}}};return{data:(b,c)=>a[b]=c,start:()=>document.querySelectorAll("[s-data]").forEach(q),store:a=>o(a)}})();export default spiki;
